# Инструкция по деплою

Для начала здесь (http://api.deploy-service.svc.k8s.datapro) надо получить доступ, его выдаст Александр Черников `@frankegoesdown`

## Настройка deploy-service

Не забывай нажимать кнопку `Save changes` каждый раз

#### Создание проекта

После того как получишь логин и пароль для входа, создаешь проект как названа твоя репа
![](_assets/deploy/add-project.png)
<br>
<br>
и генерируешь ключ
![](_assets/deploy/generate-token.png)
<br>
<br>

#### Создание кластера

Создаешь кластер `k8s.test`, копируешь все настройки с любого другого такого же кластера
![](_assets/deploy/cluster-settings.png)
<br>
<br>
Обрати внимание, это не заполняется, тут надо опять написать Черникову, чтобы он нажал на кнопку Generate
![](_assets/deploy/btn-generate.png)
<br>
<br>
Также обрати внимание здесь. Тут от кластера к кластеру конфиг может отличатся, тут 8 команд, но может быть 9 (например в `k8s.stage`)
![](_assets/deploy/plugin-configurations.png)
<br>
<br>

#### Зависимости

Теперь насчет зависимостей: <br>
У тебя для деплоя есть 4 кластера:

1.  test — для стадии тестов
2.  stage — для стадии тестов
3.  datapro — для продакшена
4.  dataline — для продакшена

`stage` зависит от `test` , поэтому в этом кластере стейджа мы указываем название `test` кластера.<br>
![](_assets/deploy/dependencies.png)
<br>
<br>
`datapro` зависит от stage<br>
`dataline` зависит от stage<br>
<br>
<br>

#### Регулярки

- test –– `^v\d+\.\d+\.\d+-test(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$`
- stage –– `^v\d+\.\d+\.\d+-stage(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$`
- dataline –– `^v\d+\.\d+\.\d+-dataline(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$`
- datapro –– `^v\d+\.\d+\.\d+-datapro(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$`

<br>
<br>

## Настройка репозитория

Запускаем npm run wb
Получаем в окошке терминала опросник, который задает нам переменные в файле .env
(рядом с каждым из вопросов отображается за какую переменную данный вопрос отвечает)
![](_assets/deploy/setup-envs-questions.png)
<br>
<br>

### –– Какие переменные за что отвечают

#### –– Обычная модификация

<b>REACT_APP_ROUTER_PREFIX</b> - префикс первого роута приложения (если он один то должен заканчиваться на /)
<br>
<b>DEPLOY_TOKEN</b> - токен деплоя от админки ci-cd
<br>
<b>REPO_NAME</b> - название репозитория (также как и нэймспейса в админке ci-cd)
<br>
<b>SERVER_PORT</b> - порт на котором поднимается сервер статики
<br>
<b>IP_LIMIT</b> - количество допустимых запросов в минуту с одного ip
<br>
<b>BROWSER</b> - настройка create-react-app для автозапуска браузера при старте приложения
<br>
<b>PUBLIC_URL</b> - префикс для сборки статических файлов
<br>

#### –– Модификация --euro (европортал)

<b>REACT_APP_ROUTER_PREFIX</b> - префикс первого роута приложения (если он один то НЕ должен заканчиваться на /)
<br>
<b>PROJECT_NAME</b> - название проекта (НЕ также как и нэймспейса в админке ci-cd, а как название для подключения в меню платформы - узнать название у ответственных за платформу)
<br>
<b>DEPLOY_TOKEN</b> - токен деплоя от админки ci-cd
<br>
<b>REPO_NAME</b> - название репозитория (также как и нэймспейса в админке ci-cd)
<br>
<b>BROWSER</b> - настройка create-react-app для автозапуска браузера при старте приложения
<br>
<br>

Далее вводим свои переменные для эндпоинтов (Для обычной модификации "не евро" помимо урлов для запросов нужны переменные SERVER_PORT, IP_LIMIT) в файлах:
<br>
`config/deploy/template_ci.sh (во всех местах где встречается секция env)`
![](_assets/deploy/setup-envs-sh.png)
<br>

Вводим свои переменные для эндпоинтов (в евро нет)
`config/deploy/frontend-envs.js`
![](_assets/deploy/setup-envs-js.png)

Вводим свои переменные для эндпоинтов (в евро нет)
`src/react-app-env.d.ts`
![](_assets/deploy/setup-envs-d-ts.png)

Далее выбираем команду для деплоя из списка (промежуток между закидыванием тагов 250 секунд для решения проблемы последовательных деплоев на стенды)
![](_assets/deploy/deploy-menu.png)
<br>
<br>

В админке деплой сервиса должны появится твои теги:
![](_assets/deploy/success_admin.png)
<br>
<br>

## Примеры

#### –– Обычная модификация

https://git.wildberries.ru/portals/suppliers-multiplicity-front

#### –– Модификация --euro (европортал)

https://git.wildberries.ru/infrastructure/suppliers-portal-eu-registration

## FAQ

#### –– Если я залил изменения в ветку надо ли делать тег заново?

Да, если ты изменил и залил, то это соответственно уже другой коммит.
Очень важно чтобы **ВСЕ** теги были созданы из одного и того же коммита.<br>
Иначе просто не поднимутся все кластеры кроме теста. <br>
<br>
<br>

#### –– В каком порядке создавать теги (если делать всё самому, без скрипта-для-деплоя)?

Теги создаются в порядке:
<br>
`test` ––> `stage` ––> `dataline`, `datapro` (два последних можно запустить параллельно)
<br>
<br>

#### –– Когда какие теги и кластеры создавать?

- `test` –– когда нужно протестировать фронт, если после разработки впервые надо выкатить фронт, достаточно только этого тега(и кластера соответственно). Также подходит для интеграции в "оболочку", но бекендеры для этой цели просят именно `stage`.
- `stage` –– когда бекендеру нужно интегрировать твой фронт в так называемую "оболочку", перед запуском этого тега необходим уже запущенный `test` тэг. `stage` тэг запускаешь соответственно с того же коммита, с которого запускал `test` тег
- `dataline` и `datapro` –– когда всё готово к тому, чтобы выкатывать на продакшен, перед запуском этих тегов требуются `test` и `stage` тэги (получается, что при выкатке на прод надо по-новому создать все теги, из ветки `release/<версия>`). Запускать `dataline` и `datapro` можно параллельно. Запускаешь соответственно с того же коммита, с которого запускал `test` и `stage` теги

#### –– По какой ссылке посмотреть мой фронт?

Дальше теги проходят пайплайны, (пайплайн release, который мы настраивали в
файле `.gitlab-ci.yml` должен пройти) на деплой сервисе происходит магия
(надо подождать минут 2-3 (если не `test` стенд)
если не поднялось на стенде то надо идти спрашивать у Димы Краснова) и все,
твой фронт будет доступен по адресу:
<br>`http://front.<namespace>.svc.k8s.<название-кластера>`<br>
поскольку мы выбрали в качестве неймспейса название репы, то ее и указываем,<br>
например: http://front.supplementary-documents-admin-front.svc.k8s.stage
